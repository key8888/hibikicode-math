<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hibikicode math lab</title>
    <link rel="icon" href="/static/favicon.ico" />
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/user-management.css" />
    <!-- ▼ BokehJSは読み込まない（app.jsでサーバーのバージョンに合わせて動的ロード） -->
    <script
      src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/axios@1.6.5/dist/axios.min.js"
      defer
    ></script>
    <script>
      // Monaco の AMD ローダ設定
      window.require = {
        paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs" },
      };
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.min.js"
      defer
    ></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            ["\\(", "\\)"],
            ["$", "$"],
          ],
          displayMath: [
            ["\\[", "\\]"],
            ["$$", "$$"],
          ],
        },
        options: {
          skipHtmlTags: ["script", "noscript", "style", "textarea", "pre", "code"],
        },
      };
    </script>
    <script
      id="mathjax-script"
      defer
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <!-- /static/app.js は ES Modules。BokehJS の動的ロードもここでやる -->
    <script src="/static/app.js" type="module" defer></script>
  </head>
  <body>
    <div id="auth-overlay" class="auth-overlay">
      <div class="auth-card">
        <div class="auth-hero">
          <h1>hibikicode math lab</h1>
          <p>ログインして、グラフとプログラミングの世界へ踏み出しましょう。</p>
        </div>
        <form id="login-form" class="auth-form">
          <label for="login-username">ユーザー名</label>
          <input
            id="login-username"
            name="username"
            type="text"
            autocomplete="username"
            placeholder="ユーザー名"
            required
          />
          <label for="login-password">パスワード</label>
          <input
            id="login-password"
            name="password"
            type="password"
            autocomplete="current-password"
            placeholder="パスワード"
            required
          />
          <button type="submit" id="login-submit" class="primary large">ログイン</button>
          <p class="auth-hint">初期ユーザー：admin / admin</p>
          <p id="login-error" class="auth-error" role="alert" aria-live="assertive"></p>
        </form>
      </div>
    </div>
    <header class="toolbar">
      <h1>グラフで学ぶプログラミング</h1>
      <div class="toolbar-buttons">
        <button id="run-button" class="primary">実行</button>
        <button id="reset-button">リセット</button>
        <button id="call-teacher-button" class="accent">先生を召喚する</button>
        <button id="history-button" class="secondary">プログラム履歴</button>
        <button id="user-management-button" class="secondary hidden-control">
          ユーザー管理
        </button>
        <span id="current-username" class="username-pill" aria-live="polite"></span>
        <button id="logout-button" class="ghost">ログアウト</button>
      </div>
    </header>
    <main class="workspace">
      <section class="left-pane">
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="graph" role="tab">グラフ表示</button>
          <button class="tab" data-tab="lesson" role="tab">教材</button>
          <button class="tab" data-tab="lesson-list" role="tab">教材一覧</button>
        </div>
        <div class="tab-content">
          <div id="graph" class="tab-panel active" role="tabpanel">
            <div id="bokeh-plot" class="plot-area"></div>
          </div>
          <div id="lesson" class="tab-panel" role="tabpanel">
            <header class="lesson-header">
              <h2 id="lesson-title">教材</h2>
              <div class="lesson-controls">
                <button id="prev-lesson" class="secondary">前へ</button>
                <button id="next-lesson" class="secondary">次へ</button>
              </div>
            </header>
            <article id="lesson-content" class="lesson-content">
              <p>教材を読み込んでいます...</p>
            </article>
          </div>
          <div id="lesson-list" class="tab-panel" role="tabpanel">
            <div id="materials-list" class="materials-list">
              <p>教材一覧を読み込んでいます...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- 左右をドラッグするスプリッター -->
      <div id="vertical-splitter" class="splitter vertical" aria-hidden="true"></div>

      <section class="right-pane">
        <div class="editor-toolbar">
          <label for="font-size-control">フォントサイズ</label>
          <input
            type="range"
            id="font-size-control"
            min="12"
            max="24"
            value="15"
          />
          <span id="font-size-value">15px</span>
        </div>

        <div class="editor-log-container">
          <div id="editor" class="editor"></div>

          <!-- エディタとログをドラッグするスプリッター -->
          <div
            id="horizontal-splitter"
            class="splitter horizontal"
            aria-hidden="true"
          ></div>

          <section class="log-area">
            <header class="log-header">
              <h2>実行ログ</h2>
              <p>実行時間: <span id="execution-time">-</span></p>
            </header>
            <pre id="combined-log" class="log-output"></pre>
          </section>
        </div>
      </section>
    </main>

    <template id="default-code">
      from math import sin, cos

plot = new_plot(title="一次関数と二次関数")
plot_function(lambda x: x, x_start=-10, x_end=10, legend_label="y = x")
plot_function(lambda x: 0.2 * x**2 - 5, x_start=-10, x_end=10, legend_label="y = 0.2x^2 - 5", line_color="#ff7f0e")
plot.xaxis.axis_label = "x"
plot.yaxis.axis_label = "y"
print("グラフを描画しました！")
    </template>

    <div
      id="history-modal"
      class="modal hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="history-modal-title"
    >
      <div class="modal-content">
        <header class="modal-header">
          <h2 id="history-modal-title">プログラム履歴</h2>
          <button id="history-modal-close" class="icon-button" aria-label="閉じる">
            ×
          </button>
        </header>
        <div id="history-list" class="history-list">
          <p>履歴がありません。</p>
        </div>
      </div>
    </div>

    <div
      id="user-management-modal"
      class="modal hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="user-management-title"
    >
      <div class="modal-content wide">
        <header class="modal-header">
          <h2 id="user-management-title">ユーザー管理</h2>
          <button id="user-management-close" class="icon-button" aria-label="閉じる">
            ×
          </button>
        </header>
        <section class="user-create">
          <h3>新規ユーザー作成</h3>
          <form id="user-create-form" class="user-form">
            <div class="input-grid">
              <div class="inputGroup">
                <input
                  id="new-user-username"
                  type="text"
                  required
                  autocomplete="off"
                />
                <label for="new-user-username">ユーザー名</label>
              </div>
              <div class="inputGroup">
                <input
                  id="new-user-password"
                  type="password"
                  required
                  autocomplete="new-password"
                />
                <label for="new-user-password">初期パスワード</label>
              </div>
            </div>
            <label class="admin-checkbox">
              <input id="new-user-is-admin" type="checkbox" />
              <div class="checkmark"></div>
              <span>管理者権限を付与</span>
            </label>
            <button type="submit" class="user-primary-button">
              <span>作成</span>
            </button>
          </form>
        </section>
        <section class="user-list">
          <h3>登録済みユーザー</h3>
          <div id="user-management-list">
            <p>ユーザー情報を読み込んでいます...</p>
          </div>
        </section>
      </div>
    </div>
  </body>
</html>
